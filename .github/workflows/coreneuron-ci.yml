name: CoreNEURON CI

concurrency:
  group: ${{ github.workflow }}#${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - master
      - release/**
  pull_request:
    branches:
      - master
      - release/**

env:
  BUILD_TYPE: Release
  DEFAULT_PY_VERSION: 3.8
  MACOSX_DEPLOYMENT_TARGET: 11.0

jobs:
  ci:
    runs-on: ${{ matrix.os }}

    name: ${{ matrix.os }} - ${{ toJson(matrix.config) }})

    env:
      SDK_ROOT: $(xcrun --sdk macosx --show-sdk-path)

    strategy:
      matrix:
        os: [ubuntu-20.04, macOS-11]
        config:
          # Defaults: CORENRN_ENABLE_MPI=ON
          - {cmake_option: "-DCORENRN_ENABLE_MPI_DYNAMIC=ON", flag_warnings: ON}
          - {cmake_option: "-DCORENRN_ENABLE_MPI_DYNAMIC=ON -DCORENRN_ENABLE_SHARED=OFF"}
          - {cmake_option: "-DCORENRN_ENABLE_MPI=OFF"}
          - {use_nmodl: ON, py_version: 3.6.7}
          - {use_nmodl: ON}
          - {use_ispc: ON, py_version: 3.6.7}
        include:
          - os: ubuntu-20.04
            config: {gcc_version: 10}
          - os: ubuntu-20.04
            config: {cmake_option: "-DCORENRN_ENABLE_DEBUG_CODE=ON", documentation: ON}
      fail-fast: false

    steps:

      - name: Install homebrew packages
        if: startsWith(matrix.os, 'macOS')
        run: |
          brew update
          brew install bison boost ccache coreutils flex ninja openmpi
          echo /usr/local/opt/flex/bin:/usr/local/opt/bison/bin >> $GITHUB_PATH
        shell: bash

      - name: Install apt packages
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get install bison ccache doxygen flex libboost-all-dev \
            libfl-dev libopenmpi-dev ninja-build openmpi-bin
        shell: bash

      - name: Install specific apt packages
        if: startsWith(matrix.os, 'ubuntu') && matrix.config.gcc_version
        run: |
          sudo apt-get install gcc-${{matrix.config.gcc_version}}
          echo CC="gcc-${{matrix.config.gcc_version}}" >> $GITHUB_ENV
          echo CXX="g++-${{matrix.config.gcc_version}}" >> $GITHUB_ENV
        shell: bash

      - name: Set up Python3
        uses: actions/setup-python@v3
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          PYTHON_VERSION: ${{matrix.config.py_version || env.DEFAULT_PY_VERSION}}

      - name: Install ISPC
        if: ${{ matrix.config.use_ispc == 'ON' }}
        working-directory: ${{runner.workspace}}
        run: |
          ispc_version="v1.12.0";
          if [ "${{ startsWith(matrix.os, 'ubuntu') }}" == "true" ]; then
            url_os="linux";
            ispc_version_suffix="b";
          else
            url_os="macOS";
            ispc_version_suffix="";
          fi;
          url="https://github.com/ispc/ispc/releases/download/${ispc_version}/ispc-${ispc_version}${ispc_version_suffix}-${url_os}.tar.gz";
          wget -O ispc.tar.gz $url;
          mkdir ispc && tar -xvzf ispc.tar.gz -C ispc --strip 1;

      - name: Install NMODL dependencies
        if: ${{ matrix.config.use_nmodl == 'ON' ||  matrix.config.use_ispc == 'ON' }}
        run: |
          python3 -m pip install --upgrade pip jinja2 pyyaml pytest sympy

      - uses: actions/checkout@v3

      - name: Install documentation dependencies
        if: ${{matrix.config.documentation == 'ON'}}
        working-directory: ${{runner.workspace}}/CoreNeuron
        run: |
          sudo apt-get install doxygen
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade -r docs/docs_requirements.txt

      - name: Register gcc problem matcher
        # Only report warnings from one gcc build and one clang build
        if: ${{matrix.config.flag_warnings == 'ON'}}
        run: echo "::add-matcher::.github/problem-matchers/gcc.json"

      - name: Hash config dictionary
        run: |
          cat << EOF > matrix.json
          ${{toJSON(matrix.config)}}
          EOF
          echo matrix.config JSON:
          cat matrix.json
          echo -----

      - name: Restore compiler cache
        uses: pat-s/always-upload-cache@v3
        with:
          path: |
            ${{runner.workspace}}/ccache
          key: ${{matrix.os}}-${{hashfiles('matrix.json')}}-${{github.ref}}-${{github.sha}}
          restore-keys: |
            ${{matrix.os}}-${{hashfiles('matrix.json')}}-${{github.ref}}-
            ${{matrix.os}}-${{hashfiles('matrix.json')}}-

      - name: Build and Test
        id: build-test
        shell: bash
        working-directory: ${{runner.workspace}}/CoreNeuron
        run:  |
          cmake_args=(${{matrix.config.cmake_option}})
          if [[ "${{ startsWith(matrix.os, 'macOS') }}" = "true" ]]; then
              cmake_args+=(-DCORENRN_ENABLE_OPENMP=OFF)
          else
              cmake_args+=(-DCORENRN_ENABLE_OPENMP=ON)
          fi

          if [[ "${{matrix.config.flag_warnings}}" == "ON" ]]; then
              cmake_args+=(-DCORENRN_EXTRA_CXX_FLAGS="-Wall")
          fi
          
          echo "------- Build, Test and Install -------"
          mkdir build && cd build
          if [[ "$USE_ISPC" == "ON" ]]; then
              cmake_args+=(-DCORENRN_ENABLE_ISPC=ON -DCMAKE_ISPC_COMPILER=${{runner.workspace}}/ispc/bin/ispc)
          elif [[ "$USE_NMODL" == "ON" ]]; then
              cmake_args+=(-DCORENRN_ENABLE_NMODL=ON "-DCORENRN_NMODL_FLAGS=sympy --analytic")
          fi
          cmake .. -G Ninja "${cmake_args[@]}" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            "-DCMAKE_INSTALL_PREFIX=${{runner.workspace}}/install" \
            -DPYTHON_EXECUTABLE=$(command -v python3)
          cmake --build . --parallel
          ctest --output-on-failure
          cmake --build . --target install
        env:
          CCACHE_BASEDIR: ${{runner.workspace}}/CoreNeuron
          CCACHE_DIR: ${{runner.workspace}}/ccache
          USE_ISPC: ${{matrix.config.use_ispc}}
          USE_NMODL: ${{matrix.config.use_nmodl}}

      # This step will set up an SSH connection on tmate.io for live debugging.
      # To enable it, you have to:
      #   * add 'live-debug-ci' to your PR title
      #   * push something to your PR branch (note that just re-running the pipeline disregards the title update)
      - name: live debug session on failure (manual steps required, check `.github/workflows/coreneuron-ci.yml`)
        if: failure() && contains(github.event.pull_request.title, 'live-debug-ci')
        uses: mxschmitt/action-tmate@v3

      - name: Documentation
        if: ${{ startsWith(matrix.os, 'ubuntu') && matrix.config.documentation == 'ON' }}
        id: documentation
        working-directory: ${{runner.workspace}}/CoreNeuron/build
        run: |
          echo "------- Build Doxygen Documentation -------";
          cmake --build . --target docs
          echo "-------- Disable jekyll --------";
          pushd docs;
          touch .nojekyll;
          echo ::set-output name=status::done
          
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        if: steps.documentation.outputs.status == 'done' && github.ref == 'refs/heads/master'
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: ${{runner.workspace}}/CoreNeuron/build/docs  # The folder the action should deploy.
          single-commit: true #have a single commit on the deployment branch instead of maintaining the full history
  sanitizers:
    needs: ci
    name: ${{ matrix.sanitizer }}-sanitizer
    runs-on: ubuntu-22.04
    env:
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    strategy:
      matrix:
        # Hyphens here will be replaced with commas before the value is passed
        # to CORENRN_SANITIZERS
        # TODO: might be interesting to add the thread sanitizer too
        sanitizer: [undefined, address-leak]
      fail-fast: false
    steps:
      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install bison ccache flex libboost-all-dev libfl-dev \
            libopenmpi-dev clang-14 ninja-build openmpi-bin
          # Make clang++ and llvm-symbolizer point at clang/llvm-14
          # Priority (200) chosen to be bigger than that in
          # https://github.com/actions/virtual-environments/blob/main/images/linux/scripts/installers/clang.sh
          sudo update-alternatives --install /usr/bin/clang++         clang++         /usr/bin/clang++-14         200
          sudo update-alternatives --install /usr/bin/llvm-symbolizer llvm-symbolizer /usr/bin/llvm-symbolizer-14 200
          clang++ --version
          llvm-symbolizer --version
        shell: bash

      - name: Set up Python3
        uses: actions/setup-python@v3
        with:
          python-version: ${{ env.DEFAULT_PY_VERSION }}

      - uses: actions/checkout@v3

      - name: Configure
        shell: bash
        working-directory: ${{runner.workspace}}/CoreNeuron
        run:  |
          echo "------- Configure -------"
          mkdir build && pushd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Custom \
            -DCMAKE_CXX_FLAGS="-O1 -g" \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR \
            -DCORENRN_SANITIZERS=$(echo ${{matrix.sanitizer}} | sed -e 's/-/,/g')
        env:
          INSTALL_DIR: ${{ runner.workspace }}/install

      - name: Restore compiler cache
        uses: pat-s/always-upload-cache@v3
        with:
          path: |
            ${{runner.workspace}}/ccache
          key: ${{matrix.sanitizer}}-${{github.ref}}-${{github.sha}}
          restore-keys: |
            ${{matrix.sanitizer}}-${{github.ref}}-
            ${{matrix.sanitizer}}-

      - name: Build
        shell: bash
        working-directory: ${{runner.workspace}}/CoreNeuron/build
        env:
          CCACHE_BASEDIR: ${{runner.workspace}}/CoreNeuron
          CCACHE_DIR: ${{runner.workspace}}/ccache
        run:  |
          echo "------- Building -------"
          ccache -z
          ccache -vs
          cmake --build .
          ccache -vs

      - name: Register problem matcher
        run: echo "::add-matcher::.github/problem-matchers/${{matrix.sanitizer}}.json"

      - name: Test
        shell: bash
        working-directory: ${{runner.workspace}}/CoreNeuron/build
        run: |
          echo "------- Testing -------"
          ctest -T Test --output-on-failure

      - uses: actions/upload-artifact@v3
        with:
          name: ctest-results-${{matrix.sanitizer}}-sanitizer
          path: ${{runner.workspace}}/CoreNeuron/build/Testing/*/Test.xml
