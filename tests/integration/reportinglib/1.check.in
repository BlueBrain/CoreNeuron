#!/bin/sh

OK=0
FAILED=1
sonata_reports=@ENABLE_SONATA_REPORTS_TESTS@
bin_reports=@ENABLE_BIN_REPORTS_TESTS@
test_ref=@CMAKE_CURRENT_BINARY_DIR@/@SIM_NAME@/test_ref.out

if [ "$bin_reports" = "ON" ]
then
  if [ -f test_1.bbp ]
  then
    somaDump_diff=$(@reportinglib_somaDump@ test_1.bbp 1 | sed 's/ //g' | diff $test_ref -)
    
    if [ $? -ne 0 ]
    then
      echo -e "[ERROR] The report output generated by Reportinglib differs!\n$somaDump_diff" >&2
      exit $FAILED
    fi
  else
     echo "[ERROR] Expected ReportingLib soma file 'test_1.bbp' is missing. Test failed!" >&2
     exit $FAILED
  fi
fi

if [ "$sonata_reports" = "ON" ]
then
  if [ -f test_2.h5 ]
  then
    h5dump_diff=$(@H5DUMP_EXECUTABLE@ -d /report/All/data -y -O test_2.h5 | sed '1d;$d;s/,//g;s/ //g' | diff $test_ref -)
    
    if [ $? -ne 0 ]
    then
      echo -e "[ERROR] The report output generated by Libsonata differs!\n$h5dump_diff" >&2
      exit $FAILED
    fi
  else
     echo "[ERROR] Expected SONATA soma file 'test_2.h5' doesn't exist. Test failed!" >&2
     exit $FAILED
  fi
fi

# If we reach this point, all tests were successful
exit $OK
